<!DOCTYPE html>
<html lang="en">
    <head>
        <title>To-do list</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'todo/styles.css' %}">
        <script src="{% static 'todo/init.js' %}"></script>
    </head>
    <body>
        <script>
            const csrfToken = '{{ csrf_token }}'.split('value=')[0];
            function updateItem(element, item_id) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        element.innerText = element.innerText === '☐' ? '✔' : '☐';
                }
                xmlHttp.open("POST", "{% url 'todo:update' %}", true);
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");
                xmlHttp.send("csrfmiddlewaretoken=" + csrfToken + "&action=toggle&item_id=" + item_id);
            }
        </script>
        <h1>To-do list for {{ user.username }}</h1>
        {% for category in categories %}
        <fieldset>
            <legend>{{ category.name }}</legend>
            <ul>
                {% for item in category.todo_items %}
                <li>
                    {% if category.modify %}<button onclick="updateItem(this, {{ item.id }})">{% endif %}
                    {% if item.completed %}
                        ✔
                    {% else %}
                        ☐
                    {% endif %}
                    {% if category.modify %}</button>{% endif %}
                    &nbsp;
                    {% if item.name %}
                    {{ item.name }}
                    {% else %}
                    (No name)
                    {% endif %}
                    {% if item.description %}
                        <ul>
                            <li>{{ item.description }}</li>
                        </ul>
                    {% endif %}
                </li>
                {% empty %}
                    <li>No to-do items found.</li>
                {% endfor %}
            </ul>
        </fieldset>
        {% empty %}
            <p>No categories found.</p>
        {% endfor %}
        <a href="{% url 'todo:edit' user.id %}">Edit to-do list</a>
        <br>
        <a href="{% url 'todo:user' user.id %}">Back to profile</a>
    </body>
</html>