<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Edit to-do list</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'todo/styles.css' %}">
        <script src="{% static 'todo/init.js' %}"></script>
    </head>
    <body>
        <script>
            const csrfToken = '{{ csrf_token }}'.split('value=')[0];
            function deleteItem(item_id) {
                if (!confirm("Delete item?")) return;
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        location.reload();
                }
                xmlHttp.open("POST", "{% url 'todo:update' %}", true);
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");
                xmlHttp.send("csrfmiddlewaretoken=" + csrfToken + "&action=delete&item_id=" + item_id);
            }
            function startAddItem(category_id) {
                document.getElementById('inputs__' + category_id).innerHTML = '';
                let nameInput = document.createElement("input");
                nameInput.type = "text";
                nameInput.id = "name";
                nameInput.placeholder = "Name";
                let descriptionInput = document.createElement("input");
                descriptionInput.type = "text";
                descriptionInput.id = "description";
                descriptionInput.placeholder = "Description";
                let submitButton = document.createElement("button");
                submitButton.innerText = "Add item";
                submitButton.id = "submitButton";
                submitButton.onclick = () => addItem(category_id);
                document.getElementById("inputs__" + category_id).appendChild(nameInput);
                document.getElementById("inputs__" + category_id).appendChild(descriptionInput);
                document.getElementById("inputs__" + category_id).appendChild(submitButton);
            }
            function addItem(category_id) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("POST", "{% url 'todo:update' %}", true);
                xmlHttp.onreadystatechange = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 201)
                        location.reload();
                }
                let name = document.getElementById('name').value;
                let description = document.getElementById('description').value;
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");
                xmlHttp.send("csrfmiddlewaretoken=" + csrfToken + "&action=add&user_id=" + {{ user.id }} + "&name=" + name + "&description=" + description + "&category_id=" + category_id);
            }
            function startEditItem(item_id, category_id) {
                document.getElementById('inputs__' + category_id).innerHTML = '';
                let nameInput = document.createElement("input");
                nameInput.type = "text";
                nameInput.id = "name";
                nameInput.placeholder = "Name";
                let descriptionInput = document.createElement("input");
                descriptionInput.type = "text";
                descriptionInput.id = "description";
                descriptionInput.placeholder = "Description";
                let submitButton = document.createElement("button");
                submitButton.innerText = "Submit changes";
                submitButton.id = "submitButton";
                submitButton.onclick = () => editItem(item_id);
                let deleteButton = document.createElement("button");
                deleteButton.innerText = "Delete item";
                deleteButton.id = "deleteButton";
                deleteButton.onclick = () => deleteItem(item_id);
                document.getElementById("inputs__" + category_id).appendChild(nameInput);
                document.getElementById("inputs__" + category_id).appendChild(descriptionInput);
                document.getElementById("inputs__" + category_id).appendChild(submitButton);
                document.getElementById("inputs__" + category_id).appendChild(deleteButton);
            }
            function editItem(item_id) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("POST", "{% url 'todo:update' %}", true);
                xmlHttp.onreadystatechange = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        location.reload();
                }
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");
                let name = document.getElementById('name').value;
                let description = document.getElementById('description').value;
                xmlHttp.send("csrfmiddlewaretoken=" + csrfToken + "&action=edit&item_id=" + item_id + "&name=" + name + "&description=" + description);
                document.getElementById('name').remove();
                document.getElementById('description').remove();
                document.getElementById('submitButton').remove();
                document.getElementById('deleteButton').remove();
            }
            function deleteUser() {
                if (!confirm("Delete user {{ user.username }}?")) return;
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("POST", "{% url 'todo:update' %}", true);
                xmlHttp.onreadystatechange = () => {
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200) 
                        window.location.assign(xmlHttp.responseURL);
                }
                xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");
                xmlHttp.send("csrfmiddlewaretoken=" + csrfToken + "&action=deleteUser&user_id={{ user.id }}");
            }
        </script>
        <h1>Edit to-do list for {{ user.username }}</h1>
        {% for category in categories %}
        <fieldset>
            <legend>{{ category.name }}</legend>
            <ul>
            {% for item in category.todo_items %}
                <li>
                    {% if category.modify and not item.assigned or category.super %}
                    <button onclick="startEditItem(item_id={{ item.id }}, category_id={{ category.id }})">Edit</button>
                    {% endif %}
                    {{ item.name }} - {{ item.description }}
                </li>
            {% empty %}
                <li>No to-do items found.</li>
            {% endfor %}
            </ul>
            <button onclick="startAddItem(category_id={{ category.id }})">Add item</button>
            <br>
            <div id="inputs__{{ category.id }}"></div>
            <br>
        </fieldset>
        {% empty %}
        <p>No categories found.</p>
        {% endfor %}
        <br>
        <a href="{% url 'todo:todolist' user.id %}">Back to todo list</a>
        <br>
        <button onclick="deleteUser()">Delete User</button>
    </body>
</html>